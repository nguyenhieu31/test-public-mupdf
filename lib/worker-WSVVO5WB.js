var ct=Object.defineProperty;var pt=(o,t,e)=>t in o?ct(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e;var Z=(o,t,e)=>pt(o,typeof t!="symbol"?t+"":t,e);var X=class extends Error{constructor(t){super(t)}};var O=class extends X{name="InternalError"};var k=class{static deviceToUser(t,e,n,r){let s,i;switch(e){case 0:s=t.x,i=r-t.y;break;case 90:s=t.y,i=t.x;break;case 180:s=n-t.x,i=t.y;break;case 270:s=r-t.y,i=n-t.x;break;default:throw new Error(`Unsupported rotation: ${e}`)}return{x:s,y:i}}static userToDevice(t,e,n,r){let s,i;switch(e){case 0:s=t.x,i=r-t.y;break;case 90:s=t.y,i=t.x;break;case 180:s=n-t.x,i=t.y;break;case 270:s=n-t.y,i=r-t.x;break;default:throw new Error(`Unsupported rotation: ${e}`)}return{x:s,y:i}}static deviceRectToUser(t,e,n,r){let{x:s,y:i}=this.deviceToUser({x:t.left,y:t.top},e,n,r),{x:u,y:a}=this.deviceToUser({x:t.right,y:t.bottom},e,n,r);return{left:Math.min(s,u),right:Math.max(s,u),top:Math.max(i,a),bottom:Math.min(i,a)}}static userRectToDevice(t,e,n,r){let{x:s,y:i}=this.userToDevice({x:t.left,y:t.top},e,n,r),{x:u,y:a}=this.userToDevice({x:t.right,y:t.bottom},e,n,r);return{left:Math.min(s,u),right:Math.max(s,u),top:Math.min(i,a),bottom:Math.max(i,a)}}};var w={SET_BASE_URI:"setBaseURI",OPEN_DOCUMENT:"openDocument",CLOSE_DOCUMENT:"closeDocument",DOWNLOAD_DOCUMENT:"downloadDocument",DRAW_PAGE:"drawPageAsPNG",LOAD_OUTLINE:"loadOutline",LOAD_PAGE_TEXT:"loadPageText",LOAD_PDFINFO:"loadPdfInfo",LOAD_PDF_LAYOUT:"loadPdfLayout",AUTHENTICATE_PASSWORD:"authenticatePassword",GET_PRINT_URL:"getPrintBlobURL",GET_ANNOTATIONS:"getAnnotations",GET_ACROFORM:"getAcroForm",APPLY_ANNOT_CHANGES:"applyAnnotChanges",APPLY_ACROFIELD_CHANGES:"applyAcroFieldChanges",APPLY_REDACTION:"applyRedaction",GET_STAMP_TEMPLATE_IMAGES:"getStampTemplateImages"};var F,K=class{TOAST_ID=1;fetchSub=null;get buffer(){return this.fetchSub!==null?this.fetchSub:(this.fetchSub=this.fetch().then(t=>t),this.fetchSub)}fetch(){return postMessage(["TOAST",this.TOAST_ID,{action:"SHOW",toastOption:{toastStyle:"notification",content:"LOADING_FALLBACK_FONT_DESC",header:"LOADING_FALLBACK_FONT",timeout:null}}]),new Promise(async(t,e)=>{console.debug("Fetching fallback font.");let n=await fetch(`${Y}DroidSansFallback.ttf`);if(!n.ok||n.headers.get("Content-type")!=="font/ttf"){postMessage(["TOAST",this.TOAST_ID,{action:"DISPOSE"}]),e(new Error("Failed to fetch fallback font."));return}let r=new F.Buffer(await n.arrayBuffer());postMessage(["TOAST",this.TOAST_ID,{action:"DISPOSE"}]),t(r)})}},b=class{static isCircle(t){return t.subType==="Circle"}static isSquare(t){return t.subType==="Square"}static isFreeText(t){return t.subType==="FreeText"}static isRedact(t){return t.subType==="Redact"}static isPopup(t){return t.subType==="Popup"}static isStamp(t){return t.subType==="Stamp"}static isHighlight(t){return t.subType==="Highlight"}static isStrikeOut(t){return t.subType==="StrikeOut"}static isUnderline(t){return t.subType==="Underline"}static isTextMarkUp(t){return this.isHighlight(t)||this.isStrikeOut(t)||this.isUnderline(t)}static isText(t){return t.subType==="Text"}static isLine(t){return t.subType==="Line"}static isPolyLine(t){return t.subType==="PolyLine"}static isPolygon(t){return t.subType==="Polygon"}static isInk(t){return t.subType==="Ink"}static isLink(t){return t.subType==="Link"}static isWidget(t){return t.subType==="Widget"}static isColor(t){return Array.isArray(t)&&t.length===3&&t.every(e=>typeof e=="number")}static isQuadPoint(t){return Array.isArray(t)&&t.length===8&&t.every(e=>typeof e=="number")}static isPoint(t){return Array.isArray(t)&&t.length===2&&t.every(e=>typeof e=="number")}static isRect(t){return Array.isArray(t)&&t.length===4&&t.every(e=>typeof e=="number")}};Z(b,"defaultAppearanceFontNameRegex",/\s*([^\s/]+)\s+\d+\s+Tf/);var V=class{openedDocument;constructor(t){this.openedDocument=t}apply(t,e){if(b.isInk(e)){this.applyInk(t,e);return}if(b.isFreeText(e)){this.applyFreeText(t,e);return}if(b.isTextMarkUp(e)){this.applyTextMarkup(t,e);return}if(b.isText(e)){this.applyText(t,e);return}if(b.isLine(e)){this.applyLine(t,e);return}if(b.isRedact(e)){this.applyRedact(t,e);return}if(b.isLink(e)){this.applyLink(t,e);return}if(b.isStamp(e)){this.applyStamp(t,e);return}if(b.isPolyLine(e)){this.applyPolyLine(t,e);return}if(b.isPolygon(e)){this.applyPolygon(t,e);return}if(b.isCircle(e)){this.applyCircle(t,e);return}if(b.isSquare(e)){this.applySquare(t,e);return}if(b.isPopup(e)){this.applyPopup(t,e);return}if(b.isWidget(e)){this.applyWidget(t,e);return}console.warn(`An unsupported annotation has been entered. ${e}`),this.applyCommonField(t,e)}applyInk(t,e){let r=t.getObject().get("InkList").asJS();e.inkList.every(s=>s.every(i=>b.isPoint(i)))&&!Array.isArray(r)&&t.setInkList(e.inkList),this.applyCommonField(t,e),this.applyCommonShape(t,e),t.update(),this.applyRect(t,e)}applyFreeText(t,e){let n=t.getObject(),r=n.get("CL").asJS();Array.isArray(e.CL)&&(!Array.isArray(r)||r.some((i,u)=>i!==e.CL?.[u]))&&n.put("CL",e.CL);let s=n.get("RD").asJS();Array.isArray(e.RD)&&(!Array.isArray(s)||s.some((i,u)=>i!==e.RD?.[u]))&&n.put("RD",e.RD),this.applyCommonField(t,e),this.applyCommonShape(t,e),this.applyDefaultAppearance(t,e),this.applyRect(t,e),this.applyLineEndingStyle(t,e),t.update()}applyTextMarkup(t,e){let r=t.getObject().get("QuadPoints").asJS();e.quadPoints.every(s=>b.isQuadPoint(s))&&(!Array.isArray(r)||e.quadPoints.flat().some((s,i)=>s!==r[i]))&&t.setQuadPoints(e.quadPoints),this.applyCommonField(t,e),this.applyRect(t,e),t.update()}applyText(t,e){this.applyCommonField(t,e),this.applyRect(t,e),t.update()}applyLine(t,e){let n=t.getObject(),r=n.get("L").asJS();e.L.every(u=>b.isPoint(u))&&(!Array.isArray(r)||e.L.flat().some((u,a)=>u!==r[a]))&&t.setLine(e.L[0],e.L[1]);let s=n.get("LL");typeof e.LL=="number"&&(!s.isNumber()||s.asNumber()!==e.LL)&&t.setLineLeader(e.LL);let i=n.get("LLE");typeof e.LLE=="number"&&(!i.isNumber()||i.asNumber()!==e.LLE)&&t.setLineLeaderExtension(e.LLE),this.applyCommonField(t,e),this.applyCommonShape(t,e),this.applyLineEndingStyle(t,e),this.applyRect(t,e),this.applyMeasure(t,e),t.update()}applyRedact(t,e){let n=t.getObject(),r=n.get("OverlayText");typeof e.overlayText=="string"&&(!r.isString()||r.asString()!==e.overlayText)&&n.put("OverlayText",e.overlayText);let s=n.get("OC").asJS();b.isColor(e.OC)&&(!Array.isArray(s)||s.some((i,u)=>i!==e.OC?.[u]))&&n.put("OC",e.OC),this.applyCommonField(t,e),this.applyCommonShape(t,e),this.applyRect(t,e),this.applyAligment(t,e),t.update()}applyLink(t,e){let n=t.getObject();switch(n.put("BS",{W:0}),e.A.S){case"GoTo":let r=this.openedDocument.loadPage(e.A.D.page).getObject();n.put("A",{S:e.A.S,D:[r,e.A.D.mode]});break;case"URI":n.put("A",{S:e.A.S,URI:`(${e.A.URI})`});break}this.applyCommonField(t,e),this.applyRect(t,e),t.update()}applyStamp(t,e){typeof e.name=="string"&&t.setIcon(e.name),this.applyCommonField(t,e),this.applyRect(t,e),t.update()}applyPolyLine(t,e){this.applyCommonField(t,e),this.applyCommonShape(t,e),this.applyLineEndingStyle(t,e),this.applyRect(t,e),this.applyVertices(t,e),this.applyMeasure(t,e),t.update()}applyPolygon(t,e){this.applyCommonField(t,e),this.applyCommonShape(t,e),this.applyRect(t,e),this.applyVertices(t,e),this.applyMeasure(t,e),t.update()}applyCircle(t,e){this.applyCommonField(t,e),this.applyCommonShape(t,e),this.applyRect(t,e),t.update()}applySquare(t,e){this.applyCommonField(t,e),this.applyCommonShape(t,e),this.applyRect(t,e),t.update()}applyPopup(t,e){this.applyCommonField(t,e),this.applyRect(t,e),t.update()}applyWidget(t,e){this.applyCommonField(t,e),this.applyRect(t,e),t.update()}applyCommonField(t,e){let n=t.getObject(),r=n.get("M");typeof e.M=="string"&&(!r.isString()||r.asString()!==e.M)&&n.put("M",e.M);let s=n.get("C").asJS();b.isColor(e.C)&&(!Array.isArray(s)||s.some((f,d)=>f!==e.C?.[d]))&&t.setColor(e.C);let i=n.get("Contents");typeof e.contents=="string"&&(!i.isString()||i.asString()!==e.contents)&&t.setContents(e.contents);let u=n.get("F");typeof e.F=="number"&&(!u.isNumber()||u.asNumber()!==e.F)&&t.setFlags(e.F);let a=n.get("T");typeof e.T=="string"&&(!a.isString()||a.asString()!==e.T)&&t.setAuthor(e.T);let c=n.get("CA");typeof e.CA=="number"&&(!c.isNumber()||c.asNumber()!==e.CA)&&t.setOpacity(e.CA);let p=n.get("IT");e.IT&&!p.isName()&&n.put("IT",e.IT);let g=n.get("NM");typeof e.NM=="string"&&!g.isString()&&n.put("NM",`(${e.NM})`);let l=n.get("CreationDate");typeof e.CreationDate=="string"&&!l.isString()&&n.put("CreationDate",`(${e.CreationDate})`)}applyCommonShape(t,e){let n=t.getObject(),r=n.get("BS","W");typeof e.BS?.W=="number"&&(!r.isNumber()||r.asNumber()!==e.BS.W)&&t.setBorderWidth(e.BS.W);let s=n.get("BS","S");e.BS?.S&&(!s.isName()||s.asName()!==e.BS.S)&&t.setBorderStyle(e.BS.S);let i=n.get("BS","D").asJS();e.BS?.S==="Dashed"&&Array.isArray(e.BS?.D)&&(!Array.isArray(i)||i.some((p,g)=>p!==e.BS?.D?.[g]))?t.setBorderDashPattern(e.BS.D):e.BS?.S==="Solid"&&Array.isArray(i)&&i.length>0&&t.setBorderDashPattern([]);let u=n.get("IC").asJS();b.isColor(e.IC)&&(!Array.isArray(u)||u.some((p,g)=>p!==e.IC?.[g]))?t.setInteriorColor(e.IC):typeof e.IC>"u"&&Array.isArray(u)&&n.delete("IC");let a=n.get("BE","S");e.BE?.S&&(!a.isName()||a.asName()!==e.BE.S)&&t.setBorderEffect(e.BE.S);let c=n.get("BE","I");typeof e.BE?.I=="number"&&(!c.isNumber()||c.asNumber()!==e.BE.I)&&t.setBorderEffectIntensity(e.BE.I)}applyRect(t,e){let n=t.getObject();b.isRect(e.rect)&&n.put("Rect",e.rect)}applyDefaultAppearance(t,e){if(!e.DA||typeof e.DA.fontName!="string"||typeof e.DA.fontSize!="number"||!b.isColor(e.DA.fontColor))return;let{fontName:n,fontSize:r,fontColor:s}=e.DA,u=t.getObject().get("DA");if(!u.isString()){t.setDefaultAppearance(n,r,s);return}let{color:a,font:c,size:p}=t.getDefaultAppearance(),g=u.asString()?.match(b.defaultAppearanceFontNameRegex)?.[1]??c;a.every((l,f)=>l===s[f])&&g===n&&p===r||t.setDefaultAppearance(n,r,s)}applyLineEndingStyle(t,e){if(!Array.isArray(e.LE))return;let n=t.getObject(),[r="None",s="None"]=e.LE;if(b.isFreeText(e)){n.put("LE",r);return}t.setLineEndingStyles(r,s)}applyVertices(t,e){let n=t.getObject().get("Vertices").asJS(),r=Array.isArray(n)&&e.vertices.flat().every((s,i)=>s===n[i]);!e.vertices.every(s=>b.isPoint(s))||r||t.setVertices(e.vertices)}applyMeasure(t,e){let n=e.Measure;if(!n||n.X?.length===0)return;let r=t.getObject(),s=r.get("Measure").asJS(),i={C:n.X?.[0].C,D:n.X?.[0].D,U:`(${n.X?.[0].U})`,F:"D",SS:"()",RT:"()",RD:"()"};if(!s||!Array.isArray(s.X)||s.X.length===0){s={Type:"Measure"},s.X=[i],s.D=[{...i,C:1}],s.A=[{...i,U:`(sq ${n.X?.[0].U})`,C:1}],s.R=n.R,r.put("Measure",s);return}typeof n.X?.[0].C=="number"&&s.X[0].C!==n.X[0].C&&(s.X[0].C=n.X[0].C),typeof n.X?.[0].U=="string"&&s.X[0].U!==n.X[0].U&&(s.X[0].U=n.X[0].U,s.D=[{...i,C:1}],s.A=[{...i,U:`sq ${i.U}`,C:1}],s.R=n.R),r.put("Measure",s)}applyAligment(t,e){let n=t.getObject();typeof e.Q=="number"&&n.put("Q",e.Q)}},q=class{widgetOidToKids;constructor(t){this.widgetOidToKids=t}applyAcroField(t,e){let n=t.get("Ff");typeof e.Ff=="number"&&(!n.isNumber()||n.asNumber()!==e.Ff)&&t.put("Ff",e.Ff);let r=t.get("V");e.V!==null&&e.V!==void 0&&(!r.isString()||r.asString()!==e.V)&&this.widgetOidToKids.has(e.oid)&&this.widgetOidToKids.get(e.oid)?.forEach(i=>this.applyWidget(i,t,e));let s=t.get("T");typeof e.T=="string"&&(!s.isString()||s.asString()!==e.T)&&t.put("T",`(${e.T})`)}applyWidget(t,e,n){let r=t.getObject();switch(n.FT){case"Rb":case"Cb":let s=r.get("AP","N");if(s.isIndirect()||!s.isDictionary())return;let i=Object.keys(s.asJS()),u=i.findIndex(p=>p===String(n.V));t.setChoiceValue(u>-1?i[u]:"Off"),t.update();return;case"Tx":if(typeof n.V!="string"){console.warn("The value set in the TextField is not of type string.");return}t.setTextValue(n.V),t.update();return;case"Cx":case"Lx":let a=e.get("Opt").asJS();if(!Array.isArray(a)||!a.every(Array.isArray))return;let c=a.find(p=>p[0]===String(n.V));if(!c||c.length<2)return;t.setChoiceValue(c[1]),t.update();return}}};onmessage=async o=>{let[t,e,n]=o.data;try{if(!F&&t!==w.SET_BASE_URI)throw new Error("set base uri first");let r=await ut[t](...n);postMessage(["RESULT",e,r])}catch(r){if(!(r instanceof Error)){console.error(r),postMessage(["ERROR",e,{}]);return}postMessage(["ERROR",e,r])}};var S=new Map,T=null,Y="",U=new Map,j=new Map,G=!1,J=null,v=null;function tt(o){let[t,e,n,r,s,i]=o.getTransform(),u=Math.atan2(e,t)*(180/Math.PI);return u<0&&(u=360+u),u}function et(o,t){let[e,n,r,s]=o.getBounds(),i=t*Math.PI/180,u=Math.cos(i),a=Math.sin(i),c=Math.abs(e*u+n*a),p=Math.abs(-e*a+n*u),g=Math.abs(r*u+s*a),l=Math.abs(-r*a+s*u),f=g-c,d=l-p;return{originalUpperLeftX:c,originalUpperLeftY:p,originalLowerRightX:g,originalLowerRightY:l,width:f,height:d}}function N(o,t){let e=Math.pow(10,t??5);return Math.round(o*e)/e}function W(o,t){return(o&1<<t-1)!==0}function lt(o){return o.isPDF()}function B(o){return`#${o.slice(0,3).map(e=>Math.round(e*255).toString(16).padStart(2,"0")).join("").toUpperCase()}`}function st(o,t,e){let n=t.get("Type").asName();if(n==="Page")o.set(t.asIndirect(),e.i),e.i++;else if(n==="Pages"){let r=t.get("Kids");r.isArray()?r.forEach(s=>st(o,s,e)):console.debug(`expected array (oid[${r.asIndirect()}])`)}else console.debug(`expected page tree or page object, not ${n} (oid[${t.asIndirect()}])`)}function nt(o,t){let e=t.get("Names"),n=t.get("Kids");e.isArray()?e.forEach((r,s)=>{typeof s!="number"||s%2===1||!r.isString()||o.set(r.asString(),e.get(s+1))}):n.isArray()?n.forEach(r=>nt(o,r)):console.debug(`expected name tree (oid[${t.asIndirect()}])`)}function H(o){let e=o.getObject().get("Rotate").valueOf()??0,n=F.Matrix.identity;n=F.Matrix.concat(n,F.Matrix.scale(4,4)),e!==0&&(n=F.Matrix.concat(n,F.Matrix.rotate(-e)));let s=o.toPixmap(n,F.ColorSpace.DeviceRGB,!0).asPNG();if(s===null)return null;let i=32768,u=[];for(let a=0;a<s.byteLength;a+=i)u.push(String.fromCharCode(...Array.from(s.subarray(a,a+i))));return{data:btoa(u.join("")),format:"png",type:"image"}}function $(o,t){let e=t.get("DA")?.asString()?.match(b.defaultAppearanceFontNameRegex)?.[1];return{strokeColor:B(o.color),fontName:e??o.font,fontSize:o.size}}function rt(o,t,e,n){let r=o.getObject(),s={},[i,u,a,c]=(o.hasRect()?o.getRect():o.getBounds()).map(N);s.rect=k.deviceRectToUser({left:i,top:u,right:a,bottom:c},n,t,e);let p=o.getOpacity();p!==null&&(s.opacity=p),s.Rotate=r.get("Rotate").asNumber()??0;let g=r.get("CreationDate");g.isString()&&(s.CreationDate=g.asString());let l=r.get("M");l.isString()&&(s.M=l.asString());let f=o.getContents();f?.length>0&&(s.contents=f);let d=o.getFlags();if(d!==null&&(s.F=d),!r.get("AP").isNull()){let m=H(o);m!==null&&(s.appearance=m)}if(o.hasAuthor()){let m=o.getAuthor();m?.length>0&&(s.T=m)}let D=r.get("NM");if(D.isString()&&(s.NM=D.asString()),o.hasBorder()){let m=o.getBorderWidth();m!==null&&(s.width=m),s.borderStyle={style:"solid"};let P=o.getBorderStyle();P!==null&&(s.borderStyle.style=P.toLowerCase(),P==="Dashed"&&(s.borderStyle.dashPattern=o.getBorderDashPattern())),o.hasBorderEffect()&&o.getBorderEffect()==="Cloudy"&&(s.borderEffect={style:"C",intensity:o.getBorderEffectIntensity()})}else{let m=r.get("BS","W");m.isNumber()?s.width=m.asNumber():o.getType()==="Redact"&&(s.width=2)}let h=r.get("C");r.get("C").isArray()&&(s.color=B(h.asJS()));let y=r.get("IC");if(r.get("IC").isArray()&&(s.InteriorColor=B(y.asJS())),o.getType()==="Redact"){let m=r.get("OC");if(r.get("OC").isArray()&&(s.OutlineColor=B(m.asJS())),r.get("DA").isString()){let{fontName:R,fontSize:C,strokeColor:L}=$(o.getDefaultAppearance(),r);s.fontName=R,s.fontSize=C,s.fontColor=L}let P=r.get("Q");if(P.isNumber())switch(P.asNumber()){case 0:s.alignment="left";break;case 1:s.alignment="center";break;case 2:s.alignment="right"}let x=r.get("OverlayText");x.isString()&&(s.overlayText=x.asString())}if(o.getType()==="FreeText"){let m=$(o.getDefaultAppearance(),r);s.contentsRichtext={text:o.getContents()??"",borderColor:m.strokeColor,fontName:m.fontName,fontSize:m.fontSize},r.get("DS").asString()?.split(";").forEach(L=>{let[I,E]=L.split(":").map(A=>A.trim());switch(I){case"color":s.contentsRichtext.fontColor=E?.toUpperCase();break;case"text-align":s.contentsRichtext.textAlign=E}});let x=o.getCalloutLine();x!==null&&(s.vertices=x.map(L=>{let[I,E]=L;return k.deviceToUser({x:I,y:E},n,t,e)}));let R=r.get("LE");R.isName()&&(s.LE=[R.asName()]);let C=r.get("RD");if(C.isArray()&&C.asJS()?.some(L=>L!==0)){s.textRect={left:s.rect.left,top:s.rect.top,right:s.rect.right,bottom:s.rect.bottom};let[L,I,E,A]=o.getBounds().map(N);s.rect=k.deviceRectToUser({left:L,top:I,right:E,bottom:A},n,t,e)}}if(o.hasQuadPoints()){let m=o.getQuadPoints();m.length>0&&(s.quadPoints=m.map(P=>P.reduce((x,R,C)=>(C%2===0&&x.push(k.deviceToUser({x:P[C],y:P[C+1]},n,t,e)),x),[])))}if(o.hasLine()){let[[m,P],[x,R]]=o.getLine();if(s.coordinates={sp:k.deviceToUser({x:m,y:P},n,t,e),ep:k.deviceToUser({x,y:R},n,t,e)},o.hasLineEndingStyles()){let{start:I,end:E}=o.getLineEndingStyles();s.LE=[I,E]}r.get("LL").isNumber()&&(s.LL=o.getLineLeader()),r.get("LLE").isNumber()&&(s.LLE=o.getLineLeaderExtension())}let M=r.get("Measure");return M.isDictionary()&&(s.Measure={R:M.get("R").asString()},s.Measure.X=[],M.get("X").forEach(m=>{s.Measure.X.push({C:N(m.get("C").asNumber(),6),D:m.get("D").asNumber(),U:m.get("U").asString()})})),o.hasInkList()&&(s.inkList=o.getInkList().map(m=>m.map(([P,x])=>k.deviceToUser({x:N(P),y:N(x)},n,t,e)))),o.hasVertices()&&(s.vertices=o.getVertices().map(([m,P])=>k.deviceToUser({x:N(m),y:N(P)},n,t,e))),s}function gt(o){let t={},e=o.get("CA");e.isNumber()&&(t.opacity=e.asNumber()),t.Rotate=o.get("Rotate").asNumber()??0;let n=o.get("CreationDate");n.isString()&&(t.CreationDate=n.asString());let r=o.get("M");r.isString()&&(t.M=r.asString());let s=o.get("F");s.isNumber()&&(t.F=s.asNumber());let i=o.get("NM");return i.isString()&&(t.NM=i.asString()),t}function ft(o){let t={},e=o.get("Rect");if(e.isArray()){let[f,d,D,h]=e.asJS();t.rect={left:N(f),top:N(h),right:N(D),bottom:N(d)}}let n=o.get("CA");n.isNumber()&&(t.opacity=n.asNumber()),t.Rotate=o.get("Rotate").asNumber()??0;let r=o.get("CreationDate");r.isString()&&(t.CreationDate=r.asString());let s=o.get("M");s.isString()&&(t.M=s.asString());let i=o.get("Contents");if(i.isString()){let f=i.asString();f.length>0&&(t.contents=f)}let u=o.get("F");u.isNumber()&&(t.F=u.asNumber());let a=o.get("NM");a.isString()&&(t.NM=a.asString());let c=o.get("BS","S");if(c.isName())switch(c.asName()){case"D":t.borderStyle={style:"dashed"};let f=o.get("BS","D");t.borderStyle.dashPattern=f.isArray()?f.asJS():[3];break;case"S":default:t.borderStyle={style:"solid"}}let p=o.get("BS","W");p.isNumber()&&(t.width=p.asNumber());let g=o.get("C");g.isArray()&&(t.color=B(g.asJS()));let l=at(o);return Object.keys(l).filter(f=>["dest","fit","type"].includes(f)).forEach(f=>t[f]=l[f]),t}function mt(o,t,e,n){let r=rt(o,t,e,n),s=o.getObject(),i=s.get("FT");i.isName()&&(r.FT=i.asName()),r.Ff=o.getFieldFlags()??0;let u=s.get("T");if(u.isString()&&(r.T=u.asString()),o.isText()||o.isPushButton()||o.isChoice()){let{fontName:f,fontSize:d,strokeColor:D}=$(o.getDefaultAppearance(),s);r.fontName=f,r.fontSize=d,r.fontColor=D}let a=s.get("MK");if(a.isDictionary()){let f=a.get("R");r.MK={R:f.isNumber()?f.asNumber():0};let d=a.get("BG");d.isArray()&&(r.MK.backgroundColor=B(d.asJS()));let D=a.get("BC");D.isArray()&&(r.MK.borderColor=B(D.asJS()));let h=a.get("CA");h.isString()&&(r.MK.CA=h.asString())}let c=s.get("Q");if(c.isNumber())switch(c.asNumber()){case 0:r.alignment="left";break;case 1:r.alignment="center";break;case 2:r.alignment="right"}let p=s.get("Parent");if(p.isIndirect()&&(r.Parent=p.asIndirect(),p.get("FT").asName()==="Btn")){let f=p.get("V");f.isNull()||(r.V=f.valueOf())}let g=s.get("AP","N");if(!g.isIndirect()&&g.isDictionary()){r.AP_N=Object.keys(g.asJS());let f=o.getValue();r.appearance=[{state:f,data:r.appearance.data,format:"png",type:"image"},...r.AP_N.filter(d=>d!==f).reduce((d,D)=>(o.setTextValue(D),d.push({state:D,...H(o)}),o.setTextValue(f),d),[])]}let l=s.get("A","S");if(l.isName()&&(r.type=l.asName(),r.type==="JavaScript")){let f=s.get("A","JS");f.isString()&&(r.JS=f.asString())}return r}function ot(o){if(!T||!S.get(T))throw new Error("no opened document");j.has(o)||nt(j,S.get(T).document.getTrailer().get("Root","Names","Dests"));let t=j.get(o);return t===void 0?null:it(t.get("D").isArray()?t.get("D"):t)}function it(o){if(o.isArray()){let[t,e,...n]=o.asJS(),r=o.get(0).asIndirect();if(!U.has(r)){if(!T||!S.get(T))throw new Error("no opened document");st(U,S.get(T).document.getTrailer().get("Root","Pages"),{i:0})}let s=U.get(r);if(s===void 0||s<0)return null;let i={};switch(e){case"XYZ":i.left=n[0],i.top=n[1],i.zoom=n[2];break;case"FitH":case"FitBH":i.top=n[0];break;case"FitV":case"FitBV":i.left=n[0];break;case"FitR":i.left=n[0],i.bottom=n[1],i.right=n[2],i.top=n[3];break;case"Fit":case"FitB":default:i=null;break}return{pageIndex:s,mode:e,coordinates:i}}else return o.isString()?ot(o.asString()):(console.debug("unsupported destination type",o.asIndirect()),null)}function at(o){let t=o.get("A"),e=o.get("Dest"),n={};if(t.isNull())if(e.isString()){let r=ot(e.asString());r&&(n.type="GoTo",n.dest=r.pageIndex,n.fit=r.coordinates===null?{mode:r.mode}:{mode:r.mode,args:r.coordinates})}else e.isNull()?console.debug("no action or destination",o.asIndirect()):console.debug("unsupported destination type",e.asIndirect(),e.valueOf());else{let r=o.get("A","S");switch(r.isName()&&(n.type=r.asName()),n.type){case"GoTo":let s=it(t.get("D"));n.dest=s.pageIndex,n.fit=s.coordinates===null?{mode:s.mode}:{mode:s.mode,args:s.coordinates};break;case"URI":let i=o.get("A","URI");i.isString()&&(n.dest=i.asString());break;default:console.debug("unsupported action type",t.asIndirect(),n.type)}}return n}var ut={setBaseURI:async o=>{Y=`${o}modules/mupdf/`,F=await import(`${Y}mupdf.js`)},openDocument:(o,t,e)=>{let n=F.Document.openDocument(o,t);if(!lt(n))throw new Error("doc is not pdf");v=new K,F.installLoadFontFunction((r,s,i,u)=>["JP","KR","TC","SC"].includes(s)?J?new F.Font("fallback",J):(G=!0,null):null),S.size===0&&(T=e),S.set(e,{document:n,filename:t,size:o.byteLength}),U.clear(),j.clear()},closeDocument:o=>{let t=o&&o.length>0?o:T;if(t===null)throw new O("No opened document.");S.get(t)?.document.destroy(),S.delete(t)},downloadDocument:o=>{let t=o&&o.length>0?o:T;if(t===null)throw new O("No opened document.");let e=S.get(t);if(e===void 0)throw new O("No opened document.");return e.document.saveToBuffer().asUint8Array()},drawPageAsPNG:async(o,t,e,n)=>{let r=F.Matrix.identity,s,i,u,a;try{let c=F.Matrix.scale(t,t);r=F.Matrix.concat(r,c);let p=F.Matrix.rotate(e);r=F.Matrix.concat(r,p);let g=n&&n.length>0?n:T;if(g===null||S.get(g)===void 0)throw new O("No opened document.");if(s=S.get(g).document.loadPage(o),u=F.Rect.transform(s.getBounds(),r),i=new F.Pixmap(F.ColorSpace.DeviceRGB,u,!1),i.clear(255),a=new F.DrawDevice(r,i),G=!1,s.runPageContents(a,F.Matrix.identity),G){try{J=await v?.buffer??null}catch(l){console.error(l),F.installLoadFontFunction(()=>null),postMessage(["TOAST",null,{action:"SHOW",toastOption:{toastStyle:"notification",content:"TEXT_RENDER_WARNING",header:"UNAVAILABLE_FONT"}}])}i.clear(255),s.runPageContents(a,F.Matrix.identity)}return a.close(),a.destroy(),i?.asPNG()}finally{i?.destroy(),s?.destroy()}},loadOutline:o=>{let t=o&&o.length>0?o:T;if(t===null)throw new O("No opened document.");let e=S.get(t)?.document,n=r=>{let s=r,i=[];for(;!s.isNull();){let u={},a=s.get("Title"),c=s.get("First");c.isNull()||(u.children=n(c)),a.isString()&&(u.text=a.asString());let p=at(s);Object.keys(p).filter(g=>["dest","fit"].includes(g)).forEach(g=>u[g]=p[g]),i.push(u),s=s.get("Next")}return i};return n(e.getTrailer().get("Root","Outlines","First"))},loadPdfInfo:o=>{let t=o??T;if(t===null)throw new O("No opened document.");let{document:e,filename:n,size:r}=S.get(t),s={},i={},u=e.getMetaData("format"),[a,c]=u.split(" "),p=new Map([["Author","info:Author"],["CreationDate","info:CreationDate"],["Creator","info:Creator"],["Keywords","info:Keywords"],["ModDate","info:ModDate"],["Producer","info:Producer"],["Subject","info:Subject"],["Title","info:Title"]]),g=new Map([["Printing","print"],["HighQualityPrinting","print-hq"],["ModifyingContents","edit"],["Commenting","annotate"],["FillingForms","form"],["DocumentAssembly","assemble"],["Accessibility","accessibility"],["CopyingContents","copy"]]);p.forEach((d,D)=>s[D]=e.getMetaData(d)),g.forEach((d,D)=>i[D]=e.hasPermission(d));let l={Direction:"L2R"},f=e.getTrailer().get("Root","Root","ViewerPreferences","Direction");return f.isName()&&(l.Direction=f.asName()),{...s,ViewerPreferences:l,PageCount:e.countPages(),Version:c,Security:i,FileName:n,FileSize:r}},loadPageText:(o,t)=>{let e=t??T;if(e===null)throw new O("No opened document.");let r=S.get(e).document.loadPage(o),s=r.toStructuredText(["preserve-ligatures","preserve-whitespace","preserve-spans","preserve-images"].join(",")),i=tt(r),{width:u,height:a,originalLowerRightY:c}=et(r,i),p=(h,y)=>{let M=[];for(let m=0;m<h.length;m+=2){let P=h[m],x=h[m+1],R,C;y===90?(R=x,C=a-P):y===180?(R=u-P,C=a-x):y===270?(R=u-x,C=P):(R=P,C=x),M.push(R,C)}return M},g=[],l={text:""},f=[],d,D=()=>{let h=/^\s*$/,y=h.test(l.text)?[]:[...f],M=h.test(l.text)?"":l.text;g.push({...l,rect:y,text:M})};return s.walk({beginLine:(h,y,M)=>{l.isVertical=y===1;let m=Math.atan2(M[1],M[0])*180/Math.PI;m<0&&(m=360+m);let P=Math.abs(i-m);l.rotate=i===m?0:P},onChar:(h,y,M,m,P)=>{let x=[...P],[R,C,L,I,E,A,z,Q]=p(x,i),_={left:Math.floor(Math.min(R,L,E,z)),bottom:Math.floor(c-Math.max(C,I,A,Q)),right:Math.floor(Math.max(R,L,E,z)),top:Math.floor(c-Math.min(C,I,A,Q))};_.bottom===_.top&&(_.top=_.bottom+m),Math.abs(d-_.bottom)>m&&(D(),l.text="",f.length=0),l.text=`${l.text}${h.charCodeAt(0)===65533?" ":h}`,f.push(_),d=_.bottom}}),D(),g},loadPdfLayout:o=>{let t=o??T;if(t===null)throw new O("No opened document.");let e=S.get(t).document,n=e.countPages(),r=[];for(let s=0;s<n;s++){let i=e.loadPage(s),u=tt(i),{width:a,height:c,originalUpperLeftX:p,originalUpperLeftY:g}=et(i,u),l=i.getObject().get("Annots"),f=l.isArray()?l.length>0:!!(i.getAnnotations().length||i.getWidgets().length||i.getLinks().length);r.push({bbox:{x:N(p,2),y:N(g,2),w:N(a,2),h:N(c,2)},i:s,r:u,originalR:u,annot:f,originalIndex:s,ref:s})}return r},authenticatePassword:(o,t)=>{let e=t??T;if(e===null)throw new O("No opened document.");return S.get(e).document.authenticatePassword(o??"")},getPrintBlobURL:(o,t,e,n)=>{let r,s;try{let i=n&&n.length>0?n:T;if(i===null)throw new O("No opened document.");r=S.get(i).document.loadPage(o);let[u,a,c,p]=r.getBounds(),g=Math.abs(c-u),f=g/72*e,d=Math.round(f/g);s=r.toPixmap(F.Matrix.scale(d,d),F.ColorSpace.DeviceRGB,!1,t,"Print");let D=new Blob([s.asPNG()],{type:"image/png"});return URL.createObjectURL(D)}catch(i){throw i}finally{r?.destroy(),s?.destroy()}},getAnnotations:(o,t)=>{let e=t&&t.length>0?t:T;if(e===null)throw new O("No opened document.");let r=S.get(e).document.loadPage(o),[s,i,u,a]=r.getBounds(),c=u-s,p=a-i,g=r.getObject().get("Rotate").asNumber()??0,l=r.getAnnotations(),f=r.getWidgets(),d=r.getObject().get("Annots"),D=[];d.isArray()&&d.forEach(y=>{y.get("Subtype").asName()==="Link"&&D.push(y)});let h=[];return h.push(...l.map(y=>{try{let M=y.getObject(),m={attributes:{pageIdx:o,...rt(y,c,p,g)},oid:M.asIndirect(),type:y.getType(),visible:!0},P=M.get("IT");P.isName()&&(m.IT=P.asName());let x=M.get("Popup");if(x.isIndirect()){m.Popup=x.asIndirect();let[C,L,I,E]=y.getPopup();h.push({attributes:{...gt(x),pageIdx:o,rect:{left:N(C),top:N(p-L),right:N(I),bottom:N(p-E)}},oid:m.Popup,type:x.get("Subtype").asName()??"Popup",visible:!0})}let R=M.get("IRT");return R.isIndirect()&&(m.IRT=R.asIndirect()),m}catch(M){return console.error(M),null}}).concat(D.map(y=>{try{return{attributes:{pageIdx:o,...ft(y)},oid:y.asIndirect(),type:y.get("Subtype").asName()??"Link",visible:!0}}catch(M){return console.error(M),null}})).concat(f.map(y=>{try{return{attributes:{pageIdx:o,...mt(y,c,p,g)},oid:y.getObject().asIndirect(),type:y.getType()??"Widget",visible:!0}}catch(M){return console.error(M),null}})).filter(y=>y!==null)),h},getAcroForm:o=>{let t=o&&o.length>0?o:T;if(t===null)throw new O("No opened document.");let n=S.get(t).document.getTrailer().get("Root","AcroForm");if(n.isNull())return{fields:{},props:{CO:[]}};let r=n.get("Fields"),s={};r.forEach(a=>{let c={};c.oid=a.asIndirect();let p=a.get("FT");p.isName()&&(c.FT=p.asName());let g=a.get("Ff");g.isNumber()&&(c.Ff=g.asNumber(),c.FT==="Btn"?W(c.Ff,16)?c.FT="Rb":W(c.Ff,17)||(c.FT="Cb"):c.FT==="Ch"&&(W(c.Ff,18)?c.FT="Cx":c.FT="Lx"));let l=a.get("T");l.isString()&&(c.T=l.asString());let f=a.get("V");f.isNull()||(c.V=f.asJS());let d=a.get("AA");d.isDictionary()&&(c.AA=d.asJS());let D=a.get("Kids");D.isArray()&&(c.Kids=[],D.forEach((M,m)=>{c.Kids.push({i:m,oid:M.asIndirect()})}));let h=a.get("I");h.isArray()&&(c.I=h.asJS());let y=a.get("Opt");y.isArray()&&(c.Opt=y.asJS()),s[c.oid]=c});let i=[],u=n.get("CO");return u.isArray()&&u.forEach(a=>{i.push({oid:a.asIndirect()})}),{fields:s,props:{CO:i}}},applyAnnotChanges:(o,t)=>{let e=t&&t.length>0?t:T;if(e===null)throw new O("No opened document.");let n=S.get(e).document,r=new V(n);o.forEach(s=>{let i=n.loadPage(s.pageIndex);if(!i){console.error("Cannot find a page with annotations to apply the changes.");return}let u=[...i.getAnnotations(),...i.getWidgets()];s.annots.forEach(a=>{switch(a.action){case"create":r.apply(i.createAnnotation(a.subType),a);return;case"modify":case"remove":let c=a.NM;if(!c){console.error("The NM field of the annotation does not exist.");return}let p=u.find(g=>{let l=g.getObject().get("NM");return l.isString()?l.asString()===c:!1});if(!p){console.error(`No annotation for NM (${c})`);return}switch(a.action){case"modify":r.apply(p,a);return;case"remove":i.deleteAnnotation(p);return}}})})},applyAcroFieldChanges:(o,t)=>{let e=t&&t.length>0?t:T;if(e===null)throw new O("No opened document.");let n=S.get(e).document,r=n.getTrailer().get("Root","AcroForm","Fields"),s=n.countPages(),i=new Map,u=new q(i);for(let a=0;a<s;a++)n.loadPage(a).getWidgets().forEach(p=>{let g=p.getObject().get("Parent");if(g.isNull())return;let l=g.asIndirect();if(i.has(l)){i.get(l)?.push(p);return}i.set(l,[p])});o.forEach(a=>{switch(a.action){case"create":case"remove":break;case"modify":let c=(()=>{let p=[];r.forEach(l=>p.push(l));let g=p.findIndex(l=>l.asIndirect()===a.oid);return g>-1?r.get(g):null})();if(c===null){console.error("AcroField could not be found.",a);return}u.applyAcroField(c,a);break}})},applyRedaction:(o,t)=>{let e=t&&t.length>0?t:T;if(e===null)throw new O("No opened document.");let n=S.get(e).document,r=new V(n),s=(i,u)=>{let a=u.getObject().get("Rect");if(a.isNull())return;let c=l=>{let[f,d,D,h]=l;return{left:Math.min(f,D),top:Math.min(d,h),right:Math.max(f,D),bottom:Math.max(d,h)}},p=c(a.asJS());[...i.getAnnotations().filter(l=>l.getObject().get("Subtype").asName()!=="Redact"),...i.getWidgets()].forEach(l=>{let d=l.getObject().get("Rect");if(d.isNull())return;let D=c(d.asJS());D.right<p.left||D.left>p.right||D.top>p.bottom||D.bottom<p.top||i.deleteAnnotation(l)})};o.forEach(i=>{let u=n.loadPage(i.pageIdx),a=u.getAnnotations().filter(c=>c.getType()==="Redact");i.redactions.forEach(c=>{let p=a.find(g=>{let l=g.getObject().get("NM");return l.isString()&&l.asString()===c.NM});p||(p=u.createAnnotation("Redact"),r.apply(p,c)),s(u,p),p.applyRedaction(1,F.PDFPage.REDACT_IMAGE_PIXELS,F.PDFPage.REDACT_LINE_ART_REMOVE_IF_COVERED,F.PDFPage.REDACT_TEXT_REMOVE)})})},getStampTemplateImages:o=>{let t=o&&o.length>0?o:T;if(t===null)throw new O("No opened document.");let n=S.get(t).document.loadPage(0),r=n.createAnnotation("Stamp"),s=[];return["Approved","AsIs","Confidential","Departmental","Draft","Experimental","Expired","Final","ForComment","ForPublicRelease","NotApproved","NotForPublicRelease","Sold","TopSecret"].forEach(u=>{r.setIcon(u),r.update();let a=H(r);s.push({name:u,data:`data:${a?.type}/${a?.format};base64, ${a?.data}`})}),n.deleteAnnotation(r),s}};postMessage(["INIT",0,Object.keys(ut)]);
